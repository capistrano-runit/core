#!/bin/sh

THIS_DIR=$(pwd)

cat <<EOF > puma.rb
directory "<%= current_path %>"
environment "<%= fetch(:rack_env, fetch(:rails_env, "production")) %>"
daemonize false
pidfile "<%= shared_path %>/tmp/pids/puma.pid"
state_path "<%= shared_path %>/tmp/puma/puma.state"
stdout_redirect "<%= shared_path %>/log/puma.stdout.log", "<%= shared_path %>/log/puma.stderr.log", true
quiet
threads <%= fetch(:runit_puma_threads_min, 0) %>, <%= fetch(:runit_puma_threads_max, 16) %>
workers <%= fetch(:runit_puma_workers, 1) %>
bind "<%= fetch(:runit_puma_bind) %>"
EOF

cd <%= current_path %>
<%= SSHKit.config.default_env.map { |k, v| "#{k.upcase}=\"#{v}\"" }.join(" ") %> exec <%= SSHKit.config.command_map[:puma] %> -C $THIS_DIR/puma.rb
